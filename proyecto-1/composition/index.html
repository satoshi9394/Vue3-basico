<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Platzi Comerces composition</title>
  <link rel="stylesheet" href="./styles.css" />
</head>

<body>
  <div id="app">
    <header>
      <h3>PlatziCommerce</h3>
      <button class="cart" v-on:click="cartOpen = !cartOpen">Carro ({{ cart.length }})</button>
      <div class="cart-content" v-show="cartOpen">
        <div 
          class="cart-content__product" 
          v-for="(product, index) in cart"
          :key="product.name" 
          :class="{ 'bg-gray' : index & 1}"
        >
          <img v-bind:src="product.images[0].image" :alt="product.name.toUpperCase()">
          <span> {{ product.name }} - ${{ new Intl.NumberFormat('es-MX').format(product.price) }} ({{ product.quantity }}) </span>
        </div>
        <p>
          Totol: $ {{ new Intl.NumberFormat('es-MX').format(total) }}
        </p>
      </div>
    </header>
    <main>
      <product v-for="product in products"
        :key="product.name" 
        :product="product"
        @sendtocart="addToCart($event)"
      ></product>
    </main>
  </div>
  <script src="https://unpkg.com/vue@next"></script>
  <script>
    const { createApp, ref, reactive, toRefs, watch, computed } = Vue;
    const app = createApp({
      setup() {
        const products = ref([
          {
            name: 'Camara',
            price: 450_000,
            stock: 3,
            content: `Lorem ipsum dolor sit amet consectetur adipisicing elit.
              Corrupti commodi labore voluptates laborum similique
              perferendis ad delectus doloremque autem, placeat et quos asperiores
              fuga eos nemo itaque debitis.`,
            images: [
              {
                image: './images/camara.jpg',
                thumbnail: './images/camara-thumb.jpg'
              },
              {
                image: './images/camara-2.jpg',
                thumbnail: './images/camara-2-thumb.jpg'
              }
            ],
            new: true,
            offer: false,
            quantity: 1
          },
          {
            name: 'Camara PL1',
            price: 250_000,
            stock: 5,
            content: `Lorem ipsum dolor sit amet consectetur adipisicing elit.
              Corrupti commodi labore voluptates laborum similique
              perferendis ad delectus doloremque autem, placeat et quos asperiores
              fuga eos nemo itaque debitis.`,
            images: [
              {
                image: './images/camara.jpg',
                thumbnail: './images/camara-thumb.jpg'
              },
              {
                image: './images/camara-2.jpg',
                thumbnail: './images/camara-2-thumb.jpg'
              }
            ],
            new: true,
            offer: true,
            quantity: 1
          },
          {
            name: 'Camara pl2',
            price: 650_000,
            stock: 8,
            content: `Lorem ipsum dolor sit amet consectetur adipisicing elit.
              Corrupti commodi labore voluptates laborum similique
              perferendis ad delectus doloremque autem, placeat et quos asperiores
              fuga eos nemo itaque debitis.`,
            images: [
              {
                image: './images/camara.jpg',
                thumbnail: './images/camara-thumb.jpg'
              },
              {
                image: './images/camara-2.jpg',
                thumbnail: './images/camara-2-thumb.jpg'
              }
            ],
            new: false,
            offer: true,
            quantity: 1
          }
        ]);

        const cartState = reactive({
          cartOpen: false,
          cart: [],
          total: computed( () => {
            return cartState.cart.reduce( (prev, curr) => {
              const prevPrice = prev.price || prev;
              const prevQuantity = prev.quantity || 1;
              return prevPrice * prevQuantity + curr.price * curr.quantity;
            }, 0);
          })
          //total: 0
        });

      function addToCart(product) {
        const { cart } = cartState;
        const prodIndex = cart.findIndex( prod => prod.name === product.name);
        if (prodIndex >= 0) {
          cart[prodIndex].quantity += 1;
        } else {
          cart.push(product);
        }
        product.stock -= 1;
      }

      /* otra forma de hacerlo
      const total = computed( () => {
        return cartState.cart.reduce( (prev, curr) => {
          const prevPrice = prev.price || prev;
          const prevQuantity = prev.quantity || 1;
          return prevPrice * prevQuantity + curr.price * curr.quantity;
        }, 0);
      });
      */

      /*
      watch( () => cartState.cart, 
        (value, oldValue) => {
          const { total, cart } = cartState;
          total = cart.reduce( (prev, curr) => {
            const prevPrice = prev.price || prev;
            const prevQuantity = prev.quantity || 1;
            return prevPrice * prevQuantity + curr.price * curr.quantity;
          }, 0);
        }
      )
      */

        return {
          ...toRefs(cartState),
          // total,
          addToCart,
          products
        }
      }
    });
  </script>
  <script src="./Badge.js"></script>
  <script src="./Product.js"></script>
  <script>
    app.mount('#app');
  </script>
</body>
</html>